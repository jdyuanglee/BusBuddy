<!DOCTYPE html>
<html lang="en">

<head>
    <title>Document</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <link href="https://fonts.googleapis.com/css?family=Assistant|Comfortaa" rel="stylesheet">
    <!-- <link rel="stylesheet" href="map.css"> -->
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
        integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>

    <style type="text/css">*{font-family: 'Comfortaa', sans-serif}.c-arrow,.c-eta{position:absolute;background-color:rgba(249,254,255,.85);border-radius:5px;z-index:999}#mapid,.p2{width:100vw}.c-arrow,.c-eta,.p2{z-index:999}.c-eta,.c-header,.p2{color:#032A4A}.arrow-trans,.c-header,.stop-listing>li img{text-align:center}<style type="text/css">*{margin:0;padding:0}body{overflow-y:hidden}#mapid{height:100vh}.c-eta{right:.25rem;top:.25rem;font-family:Comfortaa;padding:.5em 1em}.c-eta__time{font-size:2.5em;display:inline-block}.c-arrow{display:inline-block;padding:.5em .8em;top:1.2em;left:1.2em}.arrow-trans,.p2{position:absolute;background-color:#F9FEFF}.p2{transition:all .3s;display:absolute;top:92vh;height:80vh;border-radius:10px}#arrow-trans,.arrow-trans{display:inline-block;transition:all .5s}#arrow-trans{transform:rotate(90deg);margin:0 auto}.arrow-trans{margin:-1.25em auto 0;left:40%;padding:.25em 1.5em;z-index:-30;border-radius:8px}.c-header{margin:.5em 0 1rem;font-family:Comfortaa}.stop-listing>li{color:#B9B9B9;list-style-image:url(line.png);margin-left:2rem;padding:0;height:45px;list-style-position:inside;font-family:comfortaa}.stop-listing li:nth-child(5){color:#032A4A;list-style-image:url(your-stop.png)}.stop-listing li:nth-child(n+6){list-style-image:url(upcoming.png)}.stop-listing li:last-child{margin:1.5rem 1.2rem;list-style-image:url(img/school.png)}@keyframes dash{to{stroke-dashoffset:0}}.path{stroke-dasharray:1500;stroke-dashoffset:1500;animation:dash 5s linear forwards}.leaflet-bottom,.leaflet-right{display:none}
    </style>
</head>

<body>
        
    <div id="mapid"></div>
    <input type="text" id="current_center">
        <div class="c-eta">
                <div class="c-eta__static">ETA</div>
                <div class="c-eta__time">7:32</div>
                <span class="c-eta__meridiem">am</span>
    </div>
    <a onclick="window.location.replace('/dashboard')"><img class="c-arrow" src="img/arrow.svg" alt="back arrow"></a>
    <div class="p2" id="p2" ontouchstart="p2touchStart(event)" ontouchmove="p2touchMove(event)"
        ontouchend="p2touchEnd(event)">
        <div class="arrow-trans"><img id="arrow-trans" src="img/arrow.svg" alt="swipe"></div>
    <div class="swipe-fill">
        <h1 class="c-header">Bus Timeline</h1>
        <ul class="stop-listing">
            <li>Stop #1: 6:53am</li>
            <li>Stop #2: 6:58am</li>
            <li>Stop #3: 7:12am</li>
            <li>Your Stop: eta 7:23am</li>
            <li>Your Stop: eta 7:23am</li>
            <li>Your Stop: eta 7:23am</li>
            <li>Your Stop: eta 7:23am</li>
            <li>Your Stop: eta 7:23am</li>
        </ul>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='https://unpkg.com/leaflet.marker.slideto@0.2.0/Leaflet.Marker.SlideTo.js'></script>
    <!-- <script src="swipe.js"></script> -->
    <script>
    var coords = [ [-75.24364471435547, 40.01336737624207 ], [-75.24246454238892, 40.011493838944354 ], [-75.24270057678223, 40.009768166987314 ], [-75.24286150932312, 40.007837006164245 ], [-75.24253964424133, 40.00579073784958 ], [-75.24261474609375, 40.00534696072415 ], [-75.24300634860991, 40.00539216037812 ], [-75.2439022064209, 40.00583182817823 ], [-75.24851560592651, 40.00728640987835 ], [-75.2547812461853, 40.00942302736047 ], [-75.25830030441284, 40.01078714046552 ], [-75.25978088378906, 40.0112308822256 ], [-75.26121854782104, 40.011017229145686 ], [-75.26257038116455, 40.01064744338845 ], [-75.26417970657349, 40.010039346898395 ], [-75.26459813117981, 40.01062279093339 ], [-75.26356816291809, 40.011033664021724 ], [-75.26356816291809, 40.011033664021724 ], [-75.26356816291809, 40.011033664021724 ], [-75.26356816291809, 40.011033664021724 ], [-75.26356816291809, 40.011033664021724 ], [-75.26356816291809, 40.011033664021724 ], [-75.26356816291809, 40.011033664021724 ], [-75.26224851608276, 40.01151027370566 ], [-75.26242017745972, 40.01221696469734 ], [-75.26426553726196, 40.011485621562215 ], [-75.26636838912964, 40.010737835647426 ], [-75.26711940765381, 40.01037626589324 ], [-75.26812791824341, 40.01001469422373 ], [-75.26786774396896, 40.00956889015377 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26808232069016, 40.00897311058388 ], [-75.26810646057129, 40.01004756445465 ], [-75.27042388916016, 40.009143627336776 ], [-75.27113199234009, 40.01009686977135 ], [-75.27027368545532, 40.01037626589324 ], [-75.27113199234009, 40.01009686977135 ], [-75.27105689048767, 40.01011330486901 ], [-75.27173280715942, 40.01115692546594 ], [-75.27251601219176, 40.01231557216097 ], [-75.27292370796204, 40.013022254814686 ], [-75.27093887329102, 40.01347419918735 ], [-75.26882529258728, 40.01347419918735 ], [-75.26589632034302, 40.01336737624207 ], [-75.26456594467163, 40.0147807124514 ], [-75.26287078857422, 40.016259753886466 ], [-75.26171207427979, 40.01734436389964 ], [-75.25990962982178, 40.01688422842362 ], [-75.26171207427979, 40.01734436389964 ], [-75.26287078857422, 40.016259753886466 ], [-75.26166915893555, 40.01734436389964 ], [-75.2605104446411, 40.01806742766483 ], [-75.25877237319946, 40.01852755516267 ], [-75.25744199752808, 40.01844538976562 ], [-75.25624036788939, 40.01810029401754 ], [-75.25396585464478, 40.01808386084316 ], [-75.25227069854736, 40.01783736275242 ], [-75.25205612182617, 40.01759086377122 ], [-75.25115489959717, 40.017081429721834 ], [-75.24900913238524, 40.017278630450136 ], [-75.24778604507446, 40.01713072995733 ], [-75.2487301826477, 40.01586534597136 ], [-75.24896621704102, 40.01489575015707 ], [-75.24971723556519, 40.014731410518195 ], [-75.25016784667969, 40.0146328065449 ], [-75.24969577789307, 40.01381110122725 ], [-75.24913787841797, 40.013465982043655 ], [-75.24868726730345, 40.013153729849954 ], [-75.24815082550049, 40.013548153436126 ], [-75.24724960327148, 40.01402474556157 ], [-75.24649858474731, 40.01423838922712 ], [-75.24611234664917, 40.01335094192795 ], [-75.24815082550049, 40.013548153436126 ], [-75.24649858474731, 40.01421373806908 ], [-75.24560809135437, 40.014821797368555 ], [-75.24498581886292, 40.01569279179173 ], [-75.24364471435547, 40.01336737624207 ] ];

        //Center on x, y of bus
        //Fetch from the api, reset varX and varY
        var getter = setInterval(fetchXY, 1500);
        var bigX = -75.24364471435547;
        var bigY = 40.01336737624207;

        
        function fetchXY(){
            fetch('/api/buddies/data', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                .then(response => response.json())
                .then(res => {
                    console.log("RES: ", res[0].x, res[0].y);
                    // console.log(res[0].y);
                    // if ((!res[0].x) || (!res[0.y])){
                    //     return clearInterval(getter);
                    // }

                    //make sure coords are different so we can still use map when bus isnt on the move
                    if ((bigX !== parseFloat(res[0].x)) && (bigY !== parseFloat(res[0].y))){
                        bigX = parseFloat(res[0].x);
                        bigY = parseFloat(res[0].y);
                        
                        var newLatLng = new L.LatLng(bigX, bigY);
                        
                        // busMarker.setLatLng(newLatLng);
                        busMarker.slideTo([bigX, bigY], {
                            duration: 2000
                        });

                        mymap.panTo(newLatLng);
                    }
                    
                })
                .catch(err => {
                    console.log('Error: ', err);
                });
            console.log('Data: ', bigX, bigY);
        }







        // var mymap = L.map('mapid').setView([39.95449073417355, -75.19163131713867], 15);
        var mymap = L.map('mapid', {
            center: [40.01336737624207, -75.24364471435547],
            zoom: 18,
            zoomControl: false,
            watch: true,
            setView: true
        })
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            // attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            //     '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            //     'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            // id: 'mapbox.streets'
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.light'
        }).addTo(mymap);
        
        var marker = L.marker([51.5, -0.09]).addTo(mymap);
        // var circle = L.circle([39.95593818515614, -75.18313407897949
        // ], {
        //         color: 'red',
        //         fillColor: '#f03',
        //         fillOpacity: 0.5,
        //         radius: 100
        //     }).addTo(mymap);
        var polygon = L.polygon([
            [
                39.954864936085286,
                -75.18327355384828
            ],
            [
                39.95454007959778,
                -75.18117070198059
            ],
            [
                39.955621557871375,
                -75.18072545528412
            ],
            [
                39.95631649115873,
                -75.18044650554657
            ],
            [
                39.95670301904338,
                -75.18053233623505
            ],
            [
                39.95692917796283,
                -75.18162667751314
            ],
            [
                39.957036089191675,
                -75.18278002738953
            ],
            [
                39.954864936085286,
                -75.18327355384828
            ],
        ], {
                color: 'red',
                fillColor: '#f03',
                strokeWidth: 0.5,
                fillOpacity: 0.5,
                radius: 100
            }).addTo(mymap).bindPopup('SCHOOL');
        var mapIcon = new L.Icon({
            iconUrl: 'drexel.png',
            iconSize: [38, 38],
            iconAnchor: [19, 19],
            popupAnchor: [-3, -76]
        });
        var mapIcon2 = new L.Icon({
            iconUrl: 'temple.png',
            iconSize: [38, 38],
            iconAnchor: [19, 19],
            popupAnchor: [-3, -76]
        });
        var bus = new L.Icon({
            iconUrl: 'img/bus.svg',
            iconSize: [60, 60],
            iconAnchor: [16.5, 9],
            popupAnchor: [-3, -76]
        });
        var dots = new L.Icon({
            iconUrl: 'img/dot.svg',
            iconSize: [12, 12],
            iconAnchor: [5.5, 5.5],
            popupAnchor: [-3, -76]
        });
        var busMarker = L.marker([bigY, bigX], { icon: bus }).addTo(mymap).openPopup('My Location');

        var geoJSON = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "properties": {
                                "stroke": "#555555",
                                "stroke-width": 2,
                                "stroke-opacity": 1
                            },
                            "geometry": {
                                "type": "LineString",
                                "coordinates": coords
                            }
                        }
                    ]
                }
            ]
        }
        L.geoJSON(geoJSON, {
            style: function (feature) {
                return {
                    color: '#3271CA',
                    weight: '5',
                    // dashArray: '100',
                    // dashOffset: '100',
                    className: 'path'
                    // icon: bus,
                }
            },
            pointToLayer: function (geoJsonPoint, latlng) {
                return L.marker(latlng, { icon: dots });
            },
        }).addTo(mymap);

        mymap.on('moveend', function (e) {
            $('#current_center').val(mymap.getCenter().lat + ',' + mymap.getCenter().lng);
        });

        $(document).on('click', '#fly', function () {
            mymap.flyTo([39.98162534206613, -75.15729904174805], 15);
        });
            
    </script>












    <script>
        var startingY;
        var p2 = document.getElementById('p2');

        function p2touchStart(evt) {
            startingY = evt.touches[0].clientY;
        };

        function p2touchMove(evt) {
            var touch = evt.touches[0];
            var change = touch.clientY - startingY;
            console.log(change);
            if (change < 0) {
                return;
            }
            // p1.style.bottom = (change - screen.height) + 'px';
            //p2.style.top = change + 150 + 'px';
            p2.style.height = "300px";
            evt.preventDefault();
        };

        function p2touchEnd(evt) {
            var change = evt.changedTouches[0].clientY - startingY;
            var half = 50;
            change = Math.abs(change);
            console.log(change);

            //var half = screen.height / 4;
            if (change < half) {
                p2.style.bottom = '0vh';
                 p2.style.height = "80px";
                 console.log('closed');
                 document.getElementsByTagName('body')[0].classList.remove('open');
            } else {
                p2.style.bottom = '80px';
                 p2.style.height = "300px";
                p2.style.display = 'block';
                console.log('open');
                document.getElementsByTagName('body')[0].classList.add('open');
                // p2.style.display = 'none';
            }
        };
    </script>
</body>

</html>